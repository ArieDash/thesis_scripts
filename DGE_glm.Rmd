---
title: "GLM DGE"
output:
  pdf_document: default
params:
  input_samples: "..\\data_analysis\\samples_red.csv"
  regex: "CG"
  input_counts: "..\\data_analysis\\CG_red_txi.csv"
  install: 0
  p : 0.05
  lfc : 1
  out : "..\\data_analysis\\"
---



```{r}
if(params$install == 1){
  if (!require("BiocManager", quietly = TRUE))
      install.packages("BiocManager")

  BiocManager::install("edgeR")
}
```

```{r}
library(edgeR)
library(pheatmap)
```



```{r}
#read in samples and select the ones we want
samples = read.csv(params$input_samples)
samples = samples[grep(params$regex, samples$Name), ]
samples
```


```{r}
#for unscaled counts and length offset

#read in txi data (counts and length offset)
c_l = read.csv(params$input_counts)
#set rownames to geneids
rownames(c_l) = c_l$X
#remove column containing geneids
c_l = c_l[,-1]
#extract counts and lengths tables from dataframe
cts = c_l[,1:length(samples$Name)]
colnames(cts) = samples$Name

normMat = c_l[,(length(samples$Name)+1):(2*length(samples$Name))]
colnames(normMat) = samples$Name
#convert lengths from dataframe to matrix so tximport provided code works
normMat = as.matrix(normMat)
```



```{r}
#for unscaled counts and length offset

#follow steps from tximport vignette to prep data for edgeR

# Obtaining per-observation scaling factors for length, adjusted to avoid
# changing the magnitude of the counts.
normMat <- normMat/exp(rowMeans(log(normMat)))
normCts <- cts/normMat

# Computing effective library sizes from scaled counts, to account for
# composition biases between samples. 
eff_lib <- calcNormFactors(normCts) * colSums(normCts)

# Combining effective library sizes with the length factors, and calculating
# offsets for a log-link GLM.
normMat <- sweep(normMat, 2, eff_lib, "*")
normMat <- log(normMat)

# Creating a DGEList object for use in edgeR.
group = factor(samples$Treatment)
y <- DGEList(counts = cts, group = group)
y <- scaleOffset(y, normMat)

# filtering using the design information
keep = filterByExpr(y)
y <- y[keep, ]
```





```{r}
#plot samples, look for outliers
points = c(15,16,17,18,19)
colors = c("green", "blue", "red", "orange", "purple")
plotMDS(y, col = colors[group], pch = points[group], labels = colnames(y))
legend("topleft", legend = levels(group), col = colors, pch = points)
```

```{r}
y$samples
```


```{r}
design = model.matrix(~group, data = y$samples)
design
```

```{r}
#calculate dispersion factors
y = estimateDisp(y, design, robust = TRUE)
plotBCV(y)
```


```{r}
#fit GLM
fit = glmFit(y, design, robust = TRUE)

lrt = glmLRT(fit, coef = 2:length(colnames(design)))
topTags(lrt)
summary(decideTests(lrt))
```



```{r}
#recalculate the design matrix to exclude the intercept
design = model.matrix(~0+group, data = y$samples)
colnames(design) = levels(y$samples$group)
design
```

```{r}
#calculate dispersion factors
y = estimateDisp(y, design, robust = TRUE)
plotBCV(y)
```

```{r}
#make heatmap of all samples
cpms = cpm(y, offset = y$offset, log = F)
cols = colorRampPalette(c("green", "black", "red"))(300)

#make dataframe to indicate which samples were in which treatment for heatmap
col_anno = data.frame(treatment = samples$Treatment)
rownames(col_anno) = samples$Name

#define annotation colors for each treatment
anno_color_opts = c(C = "#00d65c",  R = "#82b7ff", U = "#ff9289", E = "darkorange3", M = "darkorchid3")

#generate vector of treatments in samples file
treatments = unique(samples$Treatment)
#get only elements of list that match current treatments so that legend does not include extraneous colors
anno_color = list(treatment = anno_color_opts[treatments])
pheatmap(cpms, cluster_rows = T, scale = "row", border_color = NA, show_rownames = F, annotation_col = col_anno, main = "Total expression heatmap", color = cols, annotation_colors = anno_color)
```



```{r}
#make contrasts
if("E" %in% samples$Treatments){
  contrasts = makeContrasts(UvsC=U-C, RvsC=R-C, UvsR=U-R, UvsE=U-E, FvsS=(U+R)/2-(C+E+M)/3, levels = design)
} else{
  contrasts = makeContrasts(UvsC=U-C, RvsC=R-C, UvsR=U-R, levels = design)
}

```


```{r}
volcano_plot = function(FC, FDR, xlab = "logFC", ylab = "-1*log10(FDR)", main="Volcano plot", pch=20, y = F){
  if(y){
   plot(FC, -1*log10(FDR), col = ifelse(FDR<=0.05, "red", "black"), xlab = xlab, ylab = ylab, main = main, pch = 20, ylim = c(0,10)) 
  }
  else{
    plot(FC, -1*log10(FDR), col = ifelse(FDR<=0.05, "red", "black"), xlab = xlab, ylab = ylab, main = main, pch = 20)
  }
}
```



```{r}
make_heatmap = function(cpms, samples = samples, sig_genes, t1, t2, main, color, annotation_color){
  
  #select only samples that were subjected to compared treatments
  samples_comp = subset(samples, Treatment == t1 | Treatment == t2)
  #subset matrix to include only significantly differentially expressed genes for the desired samples
  sig_cpm = cpms[rownames(cpms) %in% sig_genes, colnames(cpms) %in% samples_comp$Name]
  #make dataframe to indicate which samples were in which treatment for heatmap
  col_anno = data.frame(treatment = samples_comp$Treatment)
  rownames(col_anno) = samples_comp$Name
  #get only elements of list that match current treatments so that legend does not include extraneous colors
  anno_color = list(treatment = annotation_color[c(t1,t2)])
  #make heatmap
  pheatmap(sig_cpm, scale = "row", border_color = NA, show_rownames = F, annotation_col = col_anno, main = main, color = color, annotation_colors = anno_color)
}
```



```{r}
run_test = function(fit, contrast){
  lrt = glmLRT(fit, contrast = contrasts[,contrast])
  print(topTags(lrt))
  print(summary(decideTests(lrt)))
  plotMD(lrt)
  abline(h = c(-1,1), col = "blue")
  tt = topTags(lrt, n = NULL)$table
  
  #volcano plots
  volcano_plot(tt$logFC, tt$FDR)
  volcano_plot(tt$logFC, tt$FDR, y = T, main = "Volcano plot, FDR > 10^-10")
  
  #add column that indicates if gene is significantly differentially expressed or not
  tt$threshold = tt$FDR < params$p & abs(tt$logFC) > params$lfc
  
  #return names of genes that are significantly differentially expressed
  return(subset(tt, threshold == TRUE)[,-ncol(tt)])

}
```


```{r}
write_sig_genes = function(sig_genes, comparison){
  #save significant DEGs to file
  #Upregulated genes
  write.csv(subset(sig_genes, logFC > 0), paste0(params$out, params$regex, comparison, "_P", params$p, "C", params$lfc, "_UP.csv"))
  #Downregulated genes
  write.csv(subset(sig_genes, logFC < 0), paste0(params$out, params$regex, comparison, "_P", params$p, "C", params$lfc, "_DOWN.csv"))
  #All significant genes
  write.csv(sig_genes, paste0(params$out, params$regex, comparison, "_P", params$p, "C", params$lfc, "_DE.csv"))
}
```


```{r}
#fit GLM
fit = glmFit(y, design, robust = TRUE)

#Test for DEG between any two groups

#define annotation colors for each treatment for heatmaps
anno_color_opts = c(C = "#00d65c",  R = "#82b7ff", U = "#ff9289")

##UvsC
sig_genes_UC = run_test(fit, "UvsC")

#make heatmap
make_heatmap(cpms = cpms, samples = samples, sig_genes = rownames(sig_genes_UC), t1 = "U", t2 = "C", main = "UvsC significant DEG heatmap", color = cols, annotation_color = anno_color_opts)

#save significant DEGs to file
write_sig_genes(sig_genes_UC, "UvsC")


##RvsC
lrt_RC = glmLRT(fit, contrast = contrasts[,"RvsC"])
topTags(lrt_RC)
tt_RC = topTags(lrt_RC, n = NULL)$table
summary(decideTests(lrt_RC))
plotMD(lrt_RC)
abline(h = c(-1,1), col = "blue")
#volcano plots
volcano_plot(tt_RC$logFC, tt_RC$FDR)
volcano_plot(tt_RC$logFC, tt_RC$FDR, y = T, main = "Volcano plot, FDR > 10^-10")

#heatmap
#add column that indicates if gene is significantly differentially expressed or not
tt_RC$threshold = tt_RC$FDR < params$p & abs(tt_RC$logFC) > params$lfc
#get names of genes that are significantly differentially expressed
sig_genes_RC = subset(tt_RC, threshold == TRUE)[,-ncol(tt_RC)]
#make heatmap
make_heatmap(cpms = cpms, samples = samples, sig_genes = rownames(sig_genes_RC), t1 = "R", t2 = "C", main = "RvsC significant DEG heatmap", color = cols, annotation_color = anno_color_opts)

#save significant DEGs to file
#Upregulated genes
write.csv(subset(sig_genes_RC, logFC > 0), paste0(params$out, params$regex, "_RvsC_P", params$p, "C", params$lfc, "_UP.csv"))
#Downregulated genes
write.csv(subset(sig_genes_RC, logFC < 0), paste0(params$out, params$regex, "_RvsC_P", params$p, "C", params$lfc, "_DOWN.csv"))
#All significant genes
write.csv(sig_genes_RC, paste0(params$out, params$regex, "_RvsC_P", params$p, "C", params$lfc, "_DE.csv"))


##UvsR
lrt_UR = glmLRT(fit, contrast = contrasts[,"UvsR"])
topTags(lrt_UR)
tt_UR = topTags(lrt_UR, n = NULL)$table
summary(decideTests(lrt_UR))
plotMD(lrt_UR)
abline(h = c(-1,1), col = "blue")
#volcano plots
volcano_plot(tt_UR$logFC, tt_UR$FDR)
volcano_plot(tt_UR$logFC, tt_UR$FDR, y = T, main = "Volcano plot, FDR > 10^-10")

#heatmap
#add column that indicates if gene is significantly differentially expressed or not
tt_UR$threshold = tt_UR$FDR < params$p & abs(tt_UR$logFC) > params$lfc
#get names of genes that are significantly differentially expressed
sig_genes_UR = subset(tt_UR, threshold == TRUE)[,-ncol(tt_UR)]
#make heatmap
make_heatmap(cpms = cpms, samples = samples, sig_genes = rownames(sig_genes_UR), t1 = "U", t2 = "R", main = "UvsR significant DEG heatmap", color = cols, annotation_color = anno_color_opts)

#save significant DEGs to file
#Upregulated genes
write.csv(subset(sig_genes_UR, logFC > 0), paste0(params$out, params$regex, "_UvsR_P", params$p, "C", params$lfc, "_UP.csv"))
#Downregulated genes
write.csv(subset(sig_genes_UR, logFC < 0), paste0(params$out, params$regex, "_UvsR_P", params$p, "C", params$lfc, "_DOWN.csv"))
#All significant genes
write.csv(sig_genes_UR, paste0(params$out, params$regex, "_UvsR_P", params$p, "C", params$lfc, "_DE.csv"))
```



```{r}
#make heatmap of significant genes shared across all treatments

#get list of shared DEGs
sig_genes = intersect(c(sig_genes_UC, sig_genes_RC), sig_genes_UR)
#only do this if there are shared DE genes
if(length(sig_genes) > 0){
  #subset matrix to include only significantly differentially expressed genes
  sig_cpm = cpms[rownames(cpms) %in% sig_genes,  colnames(cpms) %in% samples$Name]
  #make dataframe to indicate which samples were in which treatment for heatmap
  col_anno = data.frame(treatment = samples$Treatment)
  rownames(col_anno) = samples$Name
  #define annotation colors for each treatment
  anno_color = list(treatment = c(C = "#00d65c",  R = "#82b7ff", U = "#ff9289"))
  #make heatmap
  pheatmap(sig_cpm, scale = "row", border_color = NA, show_rownames = F, annotation_col = col_anno, main = "Shared DEG heatmap", color = cols, annotation_colors = anno_color)
}
```


```{r}
#compare fluctuating vs static treatments if passed in static treatments
if("E" %in% samples$Treatment){
  
  ##UvsE
  lrt_UE = glmLRT(fit, contrast = contrasts[,"UvsE"])
  topTags(lrt_UE)
  tt_UE = topTags(lrt_UE, n = NULL)$table
  summary(decideTests(lrt_UE))
  plotMD(lrt_UE)
  abline(h = c(-1,1), col = "blue")
  #volcano plots
  volcano_plot(tt_UE$logFC, tt_UE$FDR)
  volcano_plot(tt_UE$logFC, tt_UE$FDR, y = T, main = "Volcano plot, FDR > 10^-10")

  #heatmap
  #add column that indicates if gene is significantly differentially expressed or not
  tt_UE$threshold = tt_UE$FDR < params$p & abs(tt_UE$logFC) > params$lfc
  #get names of genes that are significantly differentially expressed
  sig_genes_UE = subset(tt_UE, threshold == TRUE)[,-ncol(tt_UE)]
  
  #add options to annotation colors
  anno_color_opts = c(anno_color_opts, E = "thistle1")
  
  #make heatmap
  make_heatmap(cpms = cpms, samples = samples, sig_genes = rownames(sig_genes_UE), t1 = "U", t2 = "E", main = "UvsE significant DEG heatmap", color = cols)
  
  #save significant DEGs to file
  #Upregulated genes
  write.csv(subset(sig_genes_UE, logFC > 0), paste0(params$out, params$regex, "_UvsE_P", params$p, "C", params$lfc, "_UP.csv"))
  #Downregulated genes
  write.csv(subset(sig_genes_UE, logFC < 0), paste0(params$out, params$regex, "_UvsE_P", params$p, "C", params$lfc, "_DOWN.csv"))
  #All significant genes
  write.csv(sig_genes_UE, paste0(params$out, params$regex, "_UvsE_P", params$p, "C", params$lfc, "_DE.csv"))
  
  
  ##FvsS
  lrt_FS = glmLRT(fit, contrast = contrasts[,"FvsS"])
  topTags(lrt_FS)
  tt_FS = topTags(lrt_FS, n = NULL)$table
  summary(decideTests(lrt_FS))
  plotMD(lrt_FS)
  abline(h = c(-1,1), col = "blue")
  #volcano plots
  volcano_plot(tt_FS$logFC, tt_FS$FDR)
  volcano_plot(tt_FS$logFC, tt_FS$FDR, y = T, main = "Volcano plot, FDR > 10^-10")

  #heatmap
  #add column that indicates if gene is significantly differentially expressed or not
  tt_FS$threshold = tt_FS$FDR < params$p & abs(tt_FS$logFC) > params$lfc
  #get names of genes that are significantly differentially expressed
  sig_genes_FS = subset(tt_FS, threshold == TRUE)[,-ncol(tt_FS)]
  #rename samples so that treatments are either fluctuating or static
  samples[samples == "E" | samples == "M" | samples == "C"] = "S"
  samples[samples == "U" | samples == "R"] = "Fl"
  
  #add options to annotation colors
  anno_color_opts = c(anno_color_opts, Fl = "gold3", S = "turquoise2")
  
  #make heatmap
  make_heatmap(cpms = cpms, samples = samples, sig_genes = rownames(sig_genes_FS), t1 = "F", t2 = "S", main = "FvsS significant DEG heatmap", color = cols)
  
  #save significant DEGs to file
  #Upregulated genes
  write.csv(subset(sig_genes_FS, logFC > 0), paste0(params$out, params$regex, "_FvsS_P", params$p, "C", params$lfc, "_UP.csv"))
  #Downregulated genes
  write.csv(subset(sig_genes_FS, logFC < 0), paste0(params$out, params$regex, "_FvsS_P", params$p, "C", params$lfc, "_DOWN.csv"))
  #All significant genes
  write.csv(sig_genes_FS, paste0(params$out, params$regex, "_FvsS_P", params$p, "C", params$lfc, "_DE.csv"))
}
```


















































































































---
title: "GLM DGE"
output:
  pdf_document: default
params:
  input_samples: ""
  regex: ""
  input_counts: ""
  install: 0
  p : 0.05
  lfc : 1
  deg_out : ""
  image_out : ""
---



```{r}
if(params$install == 1){
  if (!require("BiocManager", quietly = TRUE))
      install.packages("BiocManager")

  BiocManager::install("edgeR")
}
```

```{r}
library(edgeR)
library(pheatmap)
library(ggvenn)
```


```{r}
#check to make sure output directories exist, create them if not
deg_dir = unlist(strsplit(params$deg_out, params$regex))[1]
image_dir = unlist(strsplit(params$image_out, paste0(params$regex, "_[^_]*_$")))
if(!dir.exists(deg_dir)){
  dir.create(deg_dir)
}
if(!dir.exists(image_dir)){
  dir.create(image_dir)
}
```


```{r}
#read in samples and select the ones we want
samples = read.csv(params$input_samples)
samples = samples[grep(params$regex, samples$Name), ]
samples
```


```{r}
#for unscaled counts and length offset

#read in txi data (counts and length offset)
c_l = read.csv(params$input_counts)
#set rownames to geneids
rownames(c_l) = c_l$X
#remove column containing geneids
c_l = c_l[,-1]
#extract counts and lengths tables from dataframe
cts = c_l[,1:length(samples$Name)]
colnames(cts) = samples$Name

normMat = c_l[,(length(samples$Name)+1):(2*length(samples$Name))]
colnames(normMat) = samples$Name
#convert lengths from dataframe to matrix so tximport provided code works
normMat = as.matrix(normMat)
```



```{r}
#for unscaled counts and length offset

#follow steps from tximport vignette to prep data for edgeR

# Obtaining per-observation scaling factors for length, adjusted to avoid
# changing the magnitude of the counts.
normMat <- normMat/exp(rowMeans(log(normMat)))
normCts <- cts/normMat

# Computing effective library sizes from scaled counts, to account for
# composition biases between samples. 
eff_lib <- calcNormFactors(normCts) * colSums(normCts)

# Combining effective library sizes with the length factors, and calculating
# offsets for a log-link GLM.
normMat <- sweep(normMat, 2, eff_lib, "*")
normMat <- log(normMat)

# Creating a DGEList object for use in edgeR.
group = factor(samples$Treatment)
y <- DGEList(counts = cts, group = group)
y <- scaleOffset(y, normMat)

# filtering using the design information
keep = filterByExpr(y)
y <- y[keep, ]
```





```{r}
#plot samples, look for outliers
points = c(15,16,17,18,19)
colors = c("green", "blue", "red", "orange", "purple")
#save output as image
png(paste0(params$image_out, "MDS_cluster.png"), width = 700)

plotMDS(y, col = colors[group], pch = points[group], labels = colnames(y))
legend("topleft", legend = levels(group), col = colors, pch = points)

dev.off()
```

```{r}
y$samples
```


```{r}
design = model.matrix(~group, data = y$samples)
design
```

```{r}
#calculate dispersion factors
y = estimateDisp(y, design, robust = TRUE)
plotBCV(y)
```


```{r}
#fit GLM
fit = glmFit(y, design, robust = TRUE)

lrt = glmLRT(fit, coef = 2:length(colnames(design)))
topTags(lrt)
summary(decideTests(lrt))
```



```{r}
#recalculate the design matrix to exclude the intercept
design = model.matrix(~0+group, data = y$samples)
colnames(design) = levels(y$samples$group)
design
```

```{r}
#calculate dispersion factors
y = estimateDisp(y, design, robust = TRUE)
plotBCV(y)
```

```{r}
#make heatmap of all samples
cpms = cpm(y, offset = y$offset, log = F)
cols = colorRampPalette(c("green", "black", "red"))(300)

#make dataframe to indicate which samples were in which treatment for heatmap
col_anno = data.frame(treatment = samples$Treatment)
rownames(col_anno) = samples$Name

#define annotation colors for each treatment
anno_color_opts = c(C = "#00d65c",  R = "#82b7ff", U = "#ff9289", E = "darkorange3", M = "darkorchid3")

#generate vector of treatments in samples file
treatments = unique(samples$Treatment)
#get only elements of list that match current treatments so that legend does not include extraneous colors
anno_color = list(treatment = anno_color_opts[treatments])

pheatmap(cpms, cluster_rows = T, scale = "row", border_color = NA, show_rownames = F, annotation_col = col_anno, main = "Total expression heatmap", color = cols, annotation_colors = anno_color, filename = paste0(params$image_out, "total_expression_heatmap.png"))
```



```{r}
#make contrasts
if("E" %in% samples$Treatment){
  contrasts = makeContrasts(UvsC=U-C, RvsC=R-C, UvsR=U-R, UvsE=U-E, FvsS=(U+R)/2-(C+E+M)/3, levels = design)
} else{
  contrasts = makeContrasts(UvsC=U-C, RvsC=R-C, UvsR=U-R, levels = design)
}

```


```{r}
volcano_plot = function(FC, FDR, xlab = "logFC", ylab = "-1*log10(FDR)", main="Volcano plot", pch=20, y = F){
  if(y){
   plot(FC, -1*log10(FDR), col = ifelse(FDR<=0.05, "red", "black"), xlab = xlab, ylab = ylab, main = main, pch = 20, ylim = c(0,10)) 
  }
  else{
    plot(FC, -1*log10(FDR), col = ifelse(FDR<=0.05, "red", "black"), xlab = xlab, ylab = ylab, main = main, pch = 20)
  }
}
```



```{r}
make_heatmap = function(cpms, samples_comp, sig_genes, main, color, annotation_color, filename){
  
  #subset matrix to include only significantly differentially expressed genes for the desired samples
  sig_cpm = cpms[rownames(cpms) %in% sig_genes, colnames(cpms) %in% samples_comp$Name]
  #make dataframe to indicate which samples were in which treatment for heatmap
  col_anno = data.frame(treatment = samples_comp$Treatment)
  rownames(col_anno) = samples_comp$Name
  #make heatmap
  if(length(sig_cpm) > 0){
    pheatmap(sig_cpm, scale = "row", border_color = NA, show_rownames = F, annotation_col = col_anno, main = main, color = color, annotation_colors = anno_color, filename = filename)
  }
  
}
```



```{r}
run_test = function(fit, contrast){
  lrt = glmLRT(fit, contrast = contrasts[,contrast])
  print(topTags(lrt))
  print(summary(decideTests(lrt)))
  
  #save image as output
  png(paste0(params$image_out, "_", contrast, "_MDplot.png"))
  
  plotMD(lrt)
  abline(h = c(-1,1), col = "blue")
  
  dev.off()
  
  tt = topTags(lrt, n = NULL)$table
  
  #save output as image
  png(paste0(params$image_out, "_", contrast, "_volcano_plot.png"), width = 550)

  #volcano plots
  volcano_plot(tt$logFC, tt$FDR)

  dev.off()
  
  #save output as image
  png(paste0(params$image_out, "_", contrast, "_volcano_plot_fdr_cutoff.png"), width = 550)

  #volcano plots
  volcano_plot(tt$logFC, tt$FDR, y = T, main = "Volcano plot, FDR > 10^-10")

  dev.off()
  
  #add column that indicates if gene is significantly differentially expressed or not
  tt$threshold = tt$FDR < params$p & abs(tt$logFC) > params$lfc
  
  #return names of genes that are significantly differentially expressed
  return(subset(tt, threshold == TRUE)[,-ncol(tt)])

}
```


```{r}
write_sig_genes = function(sig_genes, comparison){
  #save significant DEGs to file
  #Upregulated genes
  write.csv(subset(sig_genes, logFC > 0), paste0(params$deg_out, comparison, "_P", params$p, "C", params$lfc, "_UP.csv"))
  #Downregulated genes
  write.csv(subset(sig_genes, logFC < 0), paste0(params$deg_out, comparison, "_P", params$p, "C", params$lfc, "_DOWN.csv"))
  #All significant genes
  write.csv(sig_genes, paste0(params$deg_out, comparison, "_P", params$p, "C", params$lfc, "_DE.csv"))
}
```


```{r}
#fit GLM
fit = glmFit(y, design, robust = TRUE)

#Test for DEG between any two groups

#define annotation colors for each treatment for heatmaps
anno_color_opts = c(C = "#00d65c",  R = "#82b7ff", U = "#ff9289")

##UvsC
sig_genes_UC = run_test(fit, "UvsC")

#make heatmap
#get only elements of list that match current treatments so that legend does not include extraneous colors
anno_color = list(treatment = anno_color_opts[c("U","C")])

#select only samples that were subjected to compared treatments
samples_comp = subset(samples, Treatment == "U" | Treatment == "C")

make_heatmap(cpms = cpms, samples_comp = samples_comp, sig_genes = rownames(sig_genes_UC), main = "UvsC significant DEG heatmap", color = cols, annotation_color = anno_color, filename = paste0(params$image_out, "UvsC_deg_heatmap.png"))

#save significant DEGs to file
write_sig_genes(sig_genes_UC, "UvsC")


##RvsC
sig_genes_RC = run_test(fit, "RvsC")

#make heatmap
anno_color = list(treatment = anno_color_opts[c("R","C")])

samples_comp = subset(samples, Treatment == "R" | Treatment == "C")

make_heatmap(cpms = cpms, samples_comp = samples_comp, sig_genes = rownames(sig_genes_RC), main = "RvsC significant DEG heatmap", color = cols, annotation_color = anno_color, filename = paste0(params$image_out, "RvsC_deg_heatmap.png"))

#save significant DEGs to file
write_sig_genes(sig_genes_RC, "RvsC")


##UvsR
sig_genes_UR = run_test(fit, "UvsR")

#make heatmap
anno_color = list(treatment = anno_color_opts[c("U","R")])

samples_comp = subset(samples, Treatment == "U" | Treatment == "R")

make_heatmap(cpms = cpms, samples_comp = samples_comp, sig_genes = rownames(sig_genes_UR), main = "UvsR significant DEG heatmap", color = cols, annotation_color = anno_color, filename = paste0(params$image_out, "UvsR_deg_heatmap.png"))

#save significant DEGs to file
write_sig_genes(sig_genes_UR, "UvsR")
```



```{r}
#make heatmap of significant genes shared across all treatments

#get list of shared DEGs
sig_genes = intersect(intersect(rownames(sig_genes_UC), rownames(sig_genes_RC)), rownames(sig_genes_UR))

#only do this if there are shared DE genes
if(length(sig_genes) > 0){
  samples_comp = subset(samples, Treatment == "U" | Treatment == "R" | Treatment == "C")
  
  anno_color = list(treatment = anno_color_opts)

  make_heatmap(cpms = cpms, samples_comp = samples_comp, sig_genes = sig_genes, main = "shared DEG heatmap", color = cols, annotation_color = anno_color, filename = paste0(params$image_out, "shared_deg_heatmap.png"))

}
```



```{r}
#Venn diagrams of all DEGs
ggvenn(list("UvsC" = rownames(sig_genes_UC), "RvsC" = rownames(sig_genes_RC), "UvsR" = rownames(sig_genes_UR)), show_percentage = FALSE)

#save output as image
ggsave(paste0(params$image_out, "treatment_venn_all.png"))

#Venn diagrams of upregulated DEGs
ggvenn(list("UvsC" = rownames(subset(sig_genes_UC, logFC > 0)), "RvsC" = rownames(subset(sig_genes_RC, logFC > 0)), "UvsR" = rownames(subset(sig_genes_UR, logFC > 0))), show_percentage = FALSE)

#save output as image
ggsave(paste0(params$image_out, "treatment_venn_up.png"))

#Venn diagrams of downregulated DEGs
ggvenn(list("UvsC" = rownames(subset(sig_genes_UC, logFC < 0)), "RvsC" = rownames(subset(sig_genes_RC, logFC < 0)), "UvsR" = rownames(subset(sig_genes_UR, logFC < 0))), show_percentage = FALSE)

#save output as image
ggsave(paste0(params$image_out, "treatment_venn_down.png"))
```


```{r}
#compare fluctuating vs static treatments if passed in static treatments
if("E" %in% samples$Treatment){
  
  ##UvsE
  sig_genes_UE = run_test(fit, "UvsE")
  
  #add options to annotation colors
  anno_color_opts = c(anno_color_opts, E = "thistle1")
  
  anno_color = list(treatment = anno_color_opts[c("U","E")])
  
  samples_comp = subset(samples, Treatment == "U" | Treatment == "E")

  make_heatmap(cpms = cpms, samples_comp = samples_comp, sig_genes = rownames(sig_genes_UE), main = "UvsE significant DEG heatmap", color = cols, annotation_color = anno_color)
  
  #save significant DEGs to file
  write_sig_genes(sig_genes_UE, "UvsE")
  
  
  ##FvsS
  sig_genes_FS = run_test(fit, "FvsS")

  #rename samples so that treatments are either fluctuating or static
  samples[samples == "E" | samples == "M" | samples == "C"] = "S"
  samples[samples == "U" | samples == "R"] = "Fl"
  
  #add options to annotation colors
  anno_color_opts = c(anno_color_opts, Fl = "gold3", S = "turquoise2")
  
  anno_color = list(treatment = anno_color_opts[c("Fl","S")])
  
  #make heatmap
  make_heatmap(cpms = cpms, samples_comp = samples, sig_genes = rownames(sig_genes_FS), main = "FvsS DEG heatmap", color = cols, annotation_color = anno_color)
  
  #save significant DEGs to file
  write_sig_genes(sig_genes_FS, "FvsS")
}
```

















































































































